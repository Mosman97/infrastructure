apiVersion: batch/v1
kind: Job
metadata:
  name: fix-cnpg-webhooks
  namespace: {{ .Values.namespace.name }}
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  template:
    metadata:
      annotations:
        sidecar.istio.io/inject: "false"
    spec:
      serviceAccountName: cnpg-webhook-patcher
      restartPolicy: OnFailure
      containers:
      - name: patch-webhooks
        image: bitnami/kubectl:1.31.2
        command:
        - /bin/sh
        - -c
        - |
          echo "Patching MutatingWebhookConfiguration..."
          kubectl patch mutatingwebhookconfiguration cnpg-mutating-webhook-configuration --type=json -p='[
            {"op": "replace", "path": "/webhooks/0/clientConfig/service/namespace", "value": "{{ .Values.namespace.name }}"},
            {"op": "replace", "path": "/webhooks/1/clientConfig/service/namespace", "value": "{{ .Values.namespace.name }}"},
            {"op": "replace", "path": "/webhooks/2/clientConfig/service/namespace", "value": "{{ .Values.namespace.name }}"}
          ]'
          
          echo "Patching ValidatingWebhookConfiguration..."
          kubectl patch validatingwebhookconfiguration cnpg-validating-webhook-configuration --type=json -p='[
            {"op": "replace", "path": "/webhooks/0/clientConfig/service/namespace", "value": "{{ .Values.namespace.name }}"},
            {"op": "replace", "path": "/webhooks/1/clientConfig/service/namespace", "value": "{{ .Values.namespace.name }}"},
            {"op": "replace", "path": "/webhooks/2/clientConfig/service/namespace", "value": "{{ .Values.namespace.name }}"}
          ]'
          
          echo "Webhooks patched successfully!"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cnpg-webhook-patcher
  namespace: {{ .Values.namespace.name }}
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cnpg-webhook-patcher
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
rules:
- apiGroups: ["admissionregistration.k8s.io"]
  resources: ["mutatingwebhookconfigurations", "validatingwebhookconfigurations"]
  verbs: ["get", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cnpg-webhook-patcher
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cnpg-webhook-patcher
subjects:
- kind: ServiceAccount
  name: cnpg-webhook-patcher
  namespace: {{ .Values.namespace.name }}
