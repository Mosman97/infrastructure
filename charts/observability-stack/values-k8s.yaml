namespace:
  name: observability

loki:
  enabled: true
  deploymentMode: SingleBinary
  read:
    replicas: 0
  write:
    replicas: 0
  backend:
    replicas: 0
  loki:
    auth_enabled: false
    commonConfig:
      replication_factor: 1
    storage:
      type: 'filesystem'
    schemaConfig:
      configs:
        - from: "2024-01-01"
          store: tsdb
          object_store: filesystem
          schema: v13
          index:
            prefix: index_
            period: 24h
    storage_config:
      filesystem:
        directory: /var/loki/chunks
      tsdb_shipper:
        active_index_directory: /var/loki/tsdb-index
        cache_location: /var/loki/tsdb-cache
    limits_config:
      retention_period: 8760h
      reject_old_samples: true
      reject_old_samples_max_age: 168h
      ingestion_rate_mb: 20
      ingestion_burst_size_mb: 30
      max_query_length: 8760h
    compactor:
      working_directory: /var/loki/compactor
      retention_enabled: true
      retention_delete_delay: 2h
      retention_delete_worker_count: 150
      delete_request_store: filesystem
  singleBinary:
    replicas: 1
    persistence:
      enabled: true
      storageClass: local-path
      size: 100Gi
    resources:
      requests:
        memory: 512Mi
        cpu: 500m
      limits:
        memory: 1Gi
        cpu: 1
  test:
    enabled: false

promtail:
  enabled: true
  extraVolumes:
    - name: positions
      emptyDir: {}
  extraVolumeMounts:
    - name: positions
      mountPath: /run/promtail
  config:
    clients:
      - url: http://loki-stack:3100/loki/api/v1/push
    positions:
      filename: /run/promtail/positions.yaml
    server:
      http_listen_port: 9080
      grpc_listen_port: 0
    snippets:
      scrapeConfigs: |
        - job_name: kubernetes-pods
          kubernetes_sd_configs:
            - role: pod
          relabel_configs:
            - source_labels: [__meta_kubernetes_pod_label_app]
              target_label: app
            - source_labels: [__meta_kubernetes_pod_label_component]
              target_label: component
            - source_labels: [__meta_kubernetes_namespace]
              target_label: namespace
            - source_labels: [__meta_kubernetes_pod_name]
              target_label: pod
            - source_labels: [__meta_kubernetes_pod_container_name]
              target_label: container
            # Add Istio-specific labels
            - source_labels: [__meta_kubernetes_pod_label_service_istio_io_canonical_name]
              target_label: service
            - source_labels: [__meta_kubernetes_pod_label_version]
              target_label: version
            - replacement: /var/log/pods/*$1/*.log
              separator: /
              source_labels:
                - __meta_kubernetes_pod_uid
                - __meta_kubernetes_pod_container_name
              target_label: __path__
          pipeline_stages:
            - docker: {}
            - match:
                selector: '{container="istio-proxy"}'
                stages:
                  - json:
                      expressions:
                        method: method
                        path: path
                        protocol: protocol
                        response_code: response_code
                        duration: duration
                        upstream_cluster: upstream_cluster
                        user_agent: user_agent
                  - labels:
                      method:
                      response_code:
                      upstream_cluster:
            - json:
                expressions:
                  level: level
                  message: message
                  timestamp: time
            - labels:
                level:
  resources:
    requests:
      memory: 128Mi
      cpu: 100m
    limits:
      memory: 256Mi
      cpu: 200m
  daemonset:
    enabled: true

grafana:
  enabled: true
  admin:
    existingSecret: grafana-admin-credentials
    userKey: admin-user
    passwordKey: admin-password
  initChownData:
    enabled: false
  persistence:
    enabled: true
    storageClassName: local-path
    size: 10Gi
  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
        - name: Loki
          type: loki
          access: proxy
          url: http://{{ .Release.Name }}-loki:3100
          version: 1
          isDefault: true
          jsonData:
            maxLines: 1000
  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
        - name: 'default'
          orgId: 1
          folder: ''
          type: file
          disableDeletion: false
          editable: true
          options:
            path: /var/lib/grafana/dashboards/default
  ingress:
    enabled: true
    ingressClassName: traefik
    hosts:
      - grafana.k3s.local
  resources:
    requests:
      memory: 256Mi
      cpu: 250m
    limits:
      memory: 512Mi
      cpu: 500m
