# Architecture

## Overview

```
Client → Istio Gateway (mTLS) → Services
                               ├─ Keycloak → PostgreSQL
                               ├─ Grafana → Loki
                               └─ ArgoCD
```

## Components

### Service Mesh (Istio)
- **Gateway**: LoadBalancer ingress
- **Istiod**: Control plane, mTLS CA, sidecar injection
- **mTLS**: STRICT mode (all traffic encrypted)

### IAM (iam-system namespace)
- **Keycloak**: Identity provider (1 replica dev, 2 prod)
- **PostgreSQL**: 3-node cluster (CloudNativePG)
- **CNPG Operator**: Database management (no sidecar)

### Observability (observability namespace)
- **Loki**: Log aggregation (SingleBinary)
- **Grafana**: Dashboards and queries
- **Promtail**: DaemonSet log collector

### GitOps
- **ArgoCD**: ApplicationSet auto-discovers charts
- **Sync**: Automated with prune, 5 retries

## Security

### mTLS
- STRICT mode for all services
- Port 8000 PERMISSIVE for CNPG operator status

### NetworkPolicies
- Default deny all
- Whitelist only required connections
- DNS and Istio control plane allowed

### Secrets
- Auto-generated by operators
- Stored in Kubernetes secrets
- Production: Use external secrets management

### Operator Management Flow
1. **Status Check**: CNPG Operator → PostgreSQL pods port 8000 (plain HTTP, PERMISSIVE mTLS)
2. **Health Validation**: Operator reads cluster status, instance readiness
3. **Reconciliation**: Operator updates CR status based on health checks

## Data Flow

### User Authentication
```
Browser → Gateway → Keycloak → PostgreSQL
```

### Logging
```
Apps → Promtail → Loki → Grafana
```

### GitOps
```
Git Push → ArgoCD → Kubernetes
```

### GitOps Deployment Flow
1. **Git Commit**: Developer pushes to infrastructure repository
2. **ArgoCD Sync**: ApplicationSet detects changes, triggers sync
3. **Bootstrap Wave 1-4**: Istio → Gateway → CNPG → IAM/Observability
4. **Health Check**: ArgoCD validates pod health, service availability
5. **Status Update**: Applications marked as Synced/Healthy in ArgoCD UI

### Certificate Management
1. **Istiod CA**: Issues mTLS certificates for all sidecar-injected pods
2. **Automatic Rotation**: Certificates rotated every 24 hours (default)
3. **Mutual Authentication**: All service-to-service communication encrypted + authenticated

## mTLS Architecture & Design Decisions

### STRICT Mode (Default)
All service-to-service communication in `iam-system` and `observability-system` namespaces uses STRICT mTLS:
- **Encryption**: AES-256 with forward secrecy
- **Authentication**: Mutual TLS with Istio-issued certificates
- **Certificate Rotation**: Automatic every 24 hours
- **No Plaintext**: All TCP connections encrypted by Istio sidecars

### PERMISSIVE Mode (Port 8000 Only)
**Why PERMISSIVE on PostgreSQL Port 8000?**

The CNPG (CloudNativePG) operator requires plain HTTP access to PostgreSQL's status endpoint on port 8000 for:
1. **Health Checks**: Cluster status validation
2. **Failover Detection**: Primary/replica role verification
3. **Reconciliation**: Instance readiness checks

**Design Choice:**
- CNPG Operator runs **without Istio sidecar** (`sidecar.istio.io/inject: "false"`)
- Cannot communicate via mTLS (no sidecar = no mTLS client)
- Port 8000 is **internal-only** (not exposed via Gateway/Ingress)
- PERMISSIVE policy allows both plain HTTP (operator) and mTLS (other services)

**Production Safety:**
✅ Port 8000 only accepts connections from within the cluster  
✅ Not exposed to external networks via Gateway  
✅ Kubernetes NetworkPolicies provide additional layer of defense  
✅ SQL port 5432 remains STRICT mTLS (actual data traffic)  

### Why CNPG Operator Has No Sidecar
**Technical Reason**: CNPG operator is a **controller** managing PostgreSQL instances, not a **workload** serving requests. It:
- Makes outbound HTTP requests to PostgreSQL pods
- Does not receive inbound traffic
- Runs cluster-wide (outside managed namespaces)

**Alternative Considered**: Running operator with sidecar + mTLS
- **Rejected**: Would require CNPG operator code changes to support mTLS client configuration
- **Current Approach**: Port-level PERMISSIVE is simpler, production-safe, and maintains STRICT for actual SQL traffic

## Security Features

### Service Mesh Security
✅ **Istio mTLS**: STRICT mode for all service-to-service communication  
✅ **Automatic Certificate Rotation**: Istio CA issues and rotates certs every 24h  
✅ **Zero-Trust Networking**: All traffic encrypted by default  
✅ **Authorization Policies**: Fine-grained access control per service  

### Application Security
✅ **Auto-Generated Secrets**: No plaintext credentials in Git  
✅ **RBAC**: Least privilege ServiceAccounts for all components  
✅ **Security Contexts**: runAsNonRoot, readOnlyRootFilesystem, drop ALL capabilities  
✅ **Resource Limits**: Prevent resource exhaustion attacks  

### Infrastructure Security
✅ **GitOps**: Immutable infrastructure, version-controlled deployments  
✅ **PodDisruptionBudgets**: PostgreSQL HA maintained during updates  
✅ **Audit Logging**: All Keycloak events + PostgreSQL logs captured by Loki  
✅ **Network Policies**: Namespace-level traffic segmentation (production)
